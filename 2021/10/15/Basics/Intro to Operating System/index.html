<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Intro to Operating System - Shiyu - Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Shiyu - Blog"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Shiyu - Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="Virtualization 虚拟化最重要的两个部分就是CPU虚拟化和内存虚拟化，通过对这两者进行抽象和虚拟化，即使我们的电脑只有一个CPU和一个物理内存，对于电脑上运行的多个进程来说，它们仿佛在使用自己独立的CPU和内存。其中CPU虚拟化使用的是time-sharing的方法，内存虚拟化使用的是space-sharing的方法。  The Abstraction: The Process 进程就"><meta property="og:type" content="blog"><meta property="og:title" content="Intro to Operating System"><meta property="og:url" content="https://shiyuliucolumbia.github.io/2021/10/15/Basics/Intro%20to%20Operating%20System/"><meta property="og:site_name" content="Shiyu - Blog"><meta property="og:description" content="Virtualization 虚拟化最重要的两个部分就是CPU虚拟化和内存虚拟化，通过对这两者进行抽象和虚拟化，即使我们的电脑只有一个CPU和一个物理内存，对于电脑上运行的多个进程来说，它们仿佛在使用自己独立的CPU和内存。其中CPU虚拟化使用的是time-sharing的方法，内存虚拟化使用的是space-sharing的方法。  The Abstraction: The Process 进程就"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://shiyuliucolumbia.github.io/img/og_image.png"><meta property="article:published_time" content="2021-10-15T21:28:42.000Z"><meta property="article:modified_time" content="2022-01-18T21:45:40.355Z"><meta property="article:author" content="Shiyu Liu"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://shiyuliucolumbia.github.io/2021/10/15/Basics/Intro%20to%20Operating%20System/"},"headline":"Intro to Operating System","image":["https://shiyuliucolumbia.github.io/img/og_image.png"],"datePublished":"2021-10-15T21:28:42.000Z","dateModified":"2022-01-18T21:45:40.355Z","author":{"@type":"Person","name":"Shiyu Liu"},"publisher":{"@type":"Organization","name":"Shiyu - Blog","logo":{"@type":"ImageObject","url":{"text":"Shiyu - Blog"}}},"description":"Virtualization 虚拟化最重要的两个部分就是CPU虚拟化和内存虚拟化，通过对这两者进行抽象和虚拟化，即使我们的电脑只有一个CPU和一个物理内存，对于电脑上运行的多个进程来说，它们仿佛在使用自己独立的CPU和内存。其中CPU虚拟化使用的是time-sharing的方法，内存虚拟化使用的是space-sharing的方法。  The Abstraction: The Process 进程就"}</script><link rel="canonical" href="https://shiyuliucolumbia.github.io/2021/10/15/Basics/Intro%20to%20Operating%20System/"><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.4.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/">Shiyu - Blog</a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item is-hidden-tablet catalogue" title="Catalogue" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-9-tablet is-9-desktop is-9-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2021-10-15T21:28:42.000Z" title="10/15/2021, 4:28:42 PM">2021-10-15</time></span><span class="level-item">Updated&nbsp;<time dateTime="2022-01-18T21:45:40.355Z" title="1/18/2022, 3:45:40 PM">2022-01-18</time></span><span class="level-item"><a class="link-muted" href="/categories/Basics/">Basics</a></span><span class="level-item">15 minutes read (About 2265 words)</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>&nbsp;visits</span></div></div><h1 class="title is-3 is-size-4-mobile">Intro to Operating System</h1><div class="content"><h1 id="Virtualization"><a href="#Virtualization" class="headerlink" title="Virtualization"></a>Virtualization</h1><ol>
<li>虚拟化最重要的两个部分就是CPU虚拟化和内存虚拟化，通过对这两者进行抽象和虚拟化，即使我们的电脑只有一个CPU和一个物理内存，对于电脑上运行的多个进程来说，它们仿佛在使用自己独立的CPU和内存。其中CPU虚拟化使用的是time-sharing的方法，内存虚拟化使用的是space-sharing的方法。</li>
</ol>
<h2 id="The-Abstraction-The-Process"><a href="#The-Abstraction-The-Process" class="headerlink" title="The Abstraction: The Process"></a>The Abstraction: The Process</h2><ol>
<li>进程就是操作系统对一个正在运行的程序的抽象。简单来看，进程可以分为三种状态：running，ready，blocked，同一时间只能有一个进程正在运行；ready状态表示一个进程已经准备好被运行了，但是还没有轮到它运行；blocked状态表示进程正在进行某些其他操作，所以没有准备好被运行(比如正在进行I/O操作)。</li>
</ol>
<h2 id="Mechanism-Limited-Direct-Execution"><a href="#Mechanism-Limited-Direct-Execution" class="headerlink" title="Mechanism: Limited Direct Execution"></a>Mechanism: Limited Direct Execution</h2><ol>
<li>我们知道操作系统分为用户态和内核态，我们的进程想要访问某些系统级别的操作，就需要使用系统调用(system call或者trap)进入内核态，但是系统调用是如何知道该运行的程序在什么位置呢？答案是内核会在操作系统启动(booting)的时候建立一个trap table，trap table中不同的system call number对应trap handler所在的地址，这样我们的进程在进行系统调用的时候只需要提供system call number就好了，而不需要直接访问我们没有权限的trap handler所在的地址(trap handler属于内核的代码)。图中6.2展示了这种通过系统调用实现的Limited Direct Execution，需要注意的是进程的寄存器信息会被保存在kernel virtual memory的kernel stack处。</li>
<li>前面我们提到CPU虚拟化使用的是time-sharing的方法，也就是每个进程轮流使用CPU，那么一个问题出现了：如何确保某个恶意进程不会一直占用CPU？也就是说如何让操作系统重新获得控制权并决定接下来运行的进程？早期的操作系统选择相信进程，进程会主动把控制权交还操作系统(通过yield system call);现代的操作系统通过定时中断来收回操作系统的控制权。不管使用哪种方法，我们都需要一种上下文切换机制，即保留被中断的进程的上下文，并切换到继续运行的新进程的上下文。</li>
<li>书中图6.3展示了上下文切换机制，同时我觉得CSAPP的图8.14也有助于对于上下文切换的理解。<strong>首先，我们要清楚的是操作系统内核只是一段可执行代码和数据而已，大多数时候内核代码都是不执行的，而是在运行我们的用户进程代码，只有在遇到trap或者timer interupt的时候，CPU才会切换到内核态并执行内核代码中对应的trap handler。</strong>假设我们正在以用户态运行进程A，当遇到定时中断的时候，首先CPU会把当前用户进程的寄存器保存在进程A的kernel virtual memory的kernel stack处；然后切换成内核态并且执行内核代码的switch trap handler，在这个switch trap handler中会进行进程的切换(先保存当前内核态下进程A的寄存器，然后加载以前保存的内核态下进程B的寄存器)；剩下的步骤是前面的镜像。</li>
<li>需要注意的是，上下文切换的过程中有两次寄存器的保存与恢复，第一次在定时中断发生的时候，CPU会把寄存器保存在当前进程的kernel stack上，这是通过硬件实现的；第二次发生在执行内核代码的switch trap handler的时候，当需要从进程A切换到进程B的时候，我们也需要保存当前的寄存器，这是通过内核代码，也就是软件实现的。</li>
<li>在CSAPP中我们学习过，每个进程都有自己独立的虚拟地址空间，这个虚拟地址空间分为用户虚拟地址和内核虚拟地址，内核虚拟地址空间是内核代码在运行的时候使用的地址空间。在上下文切换的时候，内核代码先使用进程A的kernel virtual memory运行，然后再切换到进程B的kernel virtual memory运行，<strong>也就是说内核代码没有自己独立的进程，他只是在进行上下文切换的时候“依附”于A和B进程来运行。</strong>所以我觉得CSAPP的这段话说的很好：During the first part of the switch, the kernel is executing instructions in kernel mode on behalf of process A(i.e. there is no seperate kernel process), then at some point it begins executing instructions(still in kernel mode) on behalf of process B</li>
<li>上下文切换的决策，比如下一个该运行系统的哪一个进程是由scheduler决定的，这个会在后面介绍。</li>
</ol>
<h2 id="Scheduling"><a href="#Scheduling" class="headerlink" title="Scheduling"></a>Scheduling</h2><ol>
<li> 进程调度策略的发展线索<table>
<thead>
<tr>
<th>策略</th>
<th>内容</th>
<th>演化</th>
<th>缺点</th>
</tr>
</thead>
<tbody><tr>
<td>FIFO</td>
<td>先到达的任务先执行</td>
<td>最符合直觉的策略</td>
<td>先到达的长任务让后到达的短任务饿死</td>
</tr>
<tr>
<td>SJF (1954)</td>
<td>最短的任务先执行</td>
<td>比FIFO优化了周转时间</td>
<td>任务会随时到达，而在长任务执行时到达的短任务饿死</td>
</tr>
<tr>
<td>STCF</td>
<td>能够以最短完成时间可以抢占其他任务</td>
<td>比SJF增加了抢占机制</td>
<td>无法确定任务的完成时间</td>
</tr>
<tr>
<td>Round Robin</td>
<td>所有进程轮番使用时间片</td>
<td>优化了响应时间</td>
<td>并不是所有的程序都能用完整个时间片，例如IO密集任务</td>
</tr>
<tr>
<td>（重叠式）RR</td>
<td>需要IO的任务让出时间片并在完成前不参与调度</td>
<td>比RR多了对IO考虑</td>
<td>周转时间差于SJF（但总体来说是有效的）</td>
</tr>
<tr>
<td>MLFQ (1962)</td>
<td>见2</td>
<td>在没有任务长短的先验知识下，同时优化了周转时间和响应时间</td>
<td>稍显复杂（但被Windows、MacOS和Unix系统采用）</td>
</tr>
<tr>
<td>Lottery (1994)</td>
<td>给每个进程分发一定量的彩票，每次调度时随机抽出一个号码，被抽中的进程获得CPU</td>
<td>在给定优先级的环境下优化了公平性</td>
<td>只能在互信环境中使用，需要提前给定彩票数</td>
</tr>
<tr>
<td>Stride (1995)</td>
<td>给每个进程分发一定量的彩票，按彩票数的倒数计算步长，程序被调度一次则累计一次步长值，每次调度已经走过步长值最小的那一个</td>
<td>在给定优先级的环境下到达绝对公平，比Lottery优化了确定性</td>
<td>只能在互信环境中使用，需要提前给定彩票数</td>
</tr>
<tr>
<td>CFS (2007)</td>
<td>见3</td>
<td>在给定优先级的情况下保持绝对公平，比Stride拥有更多细节</td>
<td>稍显复杂（但是提出后迅速被Linux系统采用）</td>
</tr>
</tbody></table>
</li>
<li>Unix的策略：MLFQ，多级反馈队列（multi-level feedback queue）在没有关于任务时间的先验知识（prior knowledge）的情况下，同时要降低响应时间和周转时间。现今的Windows系统使用的就是优化后的MLFQ调度方式。<br>MLFQ包含许多队列，每个队列代表一个优先级（例如Windows有32个优先级）并且对应一个时间配额（time allotment，一般来说高优先级队列的配额低）；进程在这些队列中，并且拥有一个记录其剩余时间配额的“账户”，首次进入一个队列时“账户”的值被设置为该队列的时间配额值。MLFQ调度遵循如下规则：<br>当新进程到达的时候（假定该进程完成时间短），将其加入最高优先级的队列；<br>调度的时候会选择优先级最高的非空队列，并将该队列中的进程轮转（RR）运行；<br>当一个进程被调度后，对该进程的运行时间计时，并在该进程的“账户”中减去对应时长；<br>当一个进程的“账户”归零（即用完了该层的时间配额）的时候，进入下一级队列；<br>定期将所有进程提升至最高优先级队列。</li>
</ol>
<h2 id="The-Abstraction-Address-Spaces"><a href="#The-Abstraction-Address-Spaces" class="headerlink" title="The Abstraction: Address Spaces"></a>The Abstraction: Address Spaces</h2></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2021/10/15/Basics/C%E8%AF%AD%E8%A8%80%E5%9F%BA%E7%A1%80-/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">C语言</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2021/10/12/Backend/LoadBalancing/"><span class="level-item">LoadBalancing</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><div class="column column-left is-3-tablet is-3-desktop is-3-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/images/Shiyu.jpg" alt="Shiyu Liu"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Shiyu Liu</p><p class="is-size-6 is-block">Software Developer</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Nashville</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">47</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">7</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">11</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/ShiyuLiuColumbia" target="_blank" rel="noopener">Follow</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/ShiyuLiuColumbia"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Linkedin" href="https://www.linkedin.com/in/shiyu-liu-6623a3158/"><i class="fab fa-linkedin"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Email" href="mailto:sl4401@columbia.edu"><i class="fas fa-envelope-open"></i></a></div></div></div><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">Catalogue</h3><ul class="menu-list"><li><a class="level is-mobile" href="#Virtualization"><span class="level-left"><span class="level-item">1</span><span class="level-item">Virtualization</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#The-Abstraction-The-Process"><span class="level-left"><span class="level-item">1.1</span><span class="level-item">The Abstraction: The Process</span></span></a></li><li><a class="level is-mobile" href="#Mechanism-Limited-Direct-Execution"><span class="level-left"><span class="level-item">1.2</span><span class="level-item">Mechanism: Limited Direct Execution</span></span></a></li><li><a class="level is-mobile" href="#Scheduling"><span class="level-left"><span class="level-item">1.3</span><span class="level-item">Scheduling</span></span></a></li><li><a class="level is-mobile" href="#The-Abstraction-Address-Spaces"><span class="level-left"><span class="level-item">1.4</span><span class="level-item">The Abstraction: Address Spaces</span></span></a></li></ul></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/">Shiyu - Blog</a><p class="is-size-7"><span>&copy; 2022 Shiyu Liu</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">Visited by <span id="busuanzi_value_site_uv">0</span> users</span></p></div><div class="level-end"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>